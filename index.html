<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS | AI-Powered Outreach Engine</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --bg-dark: #050505;
            --bg-panel: #0f1016;
            --bg-panel-light: #1a1c24;
            --primary: #00f3ff; /* Cyan Neon */
            --secondary: #bc13fe; /* Purple Neon */
            --success: #00ff9d;
            --warning: #ffbf00;
            --danger: #ff0055;
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Courier New', Courier, monospace;
            --glow-primary: 0 0 10px rgba(0, 243, 255, 0.5);
            --glow-secondary: 0 0 10px rgba(188, 19, 254, 0.5);
            --border-radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            overflow-x: hidden;
            height: 100vh;
            display: flex;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- BACKGROUND ANIMATION --- */
        #canvas-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.4;
        }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(5, 5, 5, 0.95);
            z-index: 1000;
        }
        
        .auth-box {
            background: var(--bg-panel);
            padding: 2rem;
            border: 1px solid var(--primary);
            box-shadow: var(--glow-primary);
            border-radius: var(--border-radius);
            width: 350px;
            text-align: center;
        }

        /* --- LAYOUT --- */
        #app {
            display: flex;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        aside {
            width: 260px;
            background: rgba(15, 16, 22, 0.95);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: var(--glow-primary);
            margin-bottom: 2rem;
            letter-spacing: 2px;
            text-align: center;
        }

        nav button {
            background: transparent;
            border: none;
            color: var(--text-muted);
            width: 100%;
            padding: 1rem;
            text-align: left;
            cursor: pointer;
            transition: 0.3s;
            border-left: 3px solid transparent;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        nav button:hover, nav button.active {
            background: rgba(0, 243, 255, 0.1);
            color: var(--primary);
            border-left: 3px solid var(--primary);
            box-shadow: inset 10px 0 20px -10px rgba(0, 243, 255, 0.2);
        }
        
        /* Special AI Button Style */
        nav button.ai-btn {
            color: var(--secondary);
        }
        nav button.ai-btn:hover, nav button.ai-btn.active {
            color: var(--secondary);
            border-left: 3px solid var(--secondary);
            background: rgba(188, 19, 254, 0.1);
            box-shadow: inset 10px 0 20px -10px rgba(188, 19, 254, 0.2);
        }

        main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- COMPONENTS --- */
        h1, h2, h3 { margin-bottom: 1rem; font-weight: 600; }
        h1 { color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }

        .card {
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s, border-color 0.2s;
        }
        .card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.1); }

        .btn {
            padding: 0.6rem 1.2rem;
            border: 1px solid var(--primary);
            background: transparent;
            color: var(--primary);
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
        }
        
        .btn:hover {
            background: var(--primary);
            color: #000;
            box-shadow: var(--glow-primary);
        }

        .btn-secondary { border-color: var(--secondary); color: var(--secondary); }
        .btn-secondary:hover { background: var(--secondary); box-shadow: var(--glow-secondary); color:white; }
        
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; box-shadow: 0 0 10px rgba(255, 0, 85, 0.5); }
        
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.7rem; }

        input, select, textarea {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 0.8rem;
            color: white;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-family: var(--font-main);
            transition: 0.3s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 5px rgba(0,243,255,0.3); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { color: var(--primary); font-size: 0.8rem; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }

        /* Stats */
        .stat-box { text-align: center; }
        .stat-number { font-size: 2.5rem; color: white; font-weight: bold; }
        .stat-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }

        /* Logger / Terminal */
        .terminal {
            background: #000;
            border: 1px solid #333;
            height: 200px;
            overflow-y: auto;
            padding: 1rem;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--success);
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #111; }
        .log-time { color: var(--text-muted); margin-right: 10px; }

        /* CHAT INTERFACE */
        .chat-container {
            display: flex; flex-direction: column; height: 100%;
            background: var(--bg-panel); border: 1px solid var(--secondary);
            border-radius: var(--border-radius); overflow: hidden;
            box-shadow: var(--glow-secondary);
        }
        .chat-header {
            padding: 1rem; background: rgba(188, 19, 254, 0.1);
            border-bottom: 1px solid var(--secondary);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-messages {
            flex: 1; padding: 1.5rem; overflow-y: auto;
            display: flex; flex-direction: column; gap: 1rem;
        }
        .message {
            max-width: 80%; padding: 1rem; border-radius: 8px; font-size: 0.9rem; line-height: 1.4;
        }
        .message.ai {
            align-self: flex-start; background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--secondary); color: var(--text-main);
        }
        .message.user {
            align-self: flex-end; background: rgba(188, 19, 254, 0.2);
            border-right: 3px solid var(--secondary); color: white;
        }
        .chat-input-area {
            padding: 1rem; background: #000; border-top: 1px solid #333;
            display: flex; gap: 10px;
        }

        /* Toasts */
        #toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 2000;
        }
        .toast {
            background: var(--bg-panel);
            border-left: 4px solid var(--primary);
            color: white;
            padding: 1rem;
            margin-top: 10px;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease;
            min-width: 250px;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center; z-index: 1500;
        }
        .modal {
            background: var(--bg-panel); width: 600px; max-width: 90%;
            padding: 2rem; border-radius: var(--border-radius);
            border: 1px solid var(--primary);
            box-shadow: var(--glow-primary);
            max-height: 90vh; overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #app { flex-direction: column; }
            aside { width: 100%; height: auto; flex-direction: row; overflow-x: auto; }
            nav button { flex-direction: column; font-size: 0.7rem; padding: 0.5rem; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Background -->
    <canvas id="canvas-bg"></canvas>

    <!-- Notifications -->
    <div id="toast-container"></div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-box">
            <h2 style="color:var(--primary); margin-bottom: 20px;">NEXUS LOGIN</h2>
            <input type="email" id="login-email" value="admin@nexus.com" placeholder="admin@nexus.com">
            <input type="password" id="login-pass" value="admin" placeholder="Password">
            <button class="btn" style="width:100%" onclick="Auth.login()">Initialize System</button>
            <p style="margin-top:10px; font-size: 0.8rem; color: #666;">(Use: admin@nexus.com / admin)</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" style="display:none;">
        <aside>
            <div class="brand">NEXUS</div>
            <nav>
                <button onclick="Router.nav('dashboard')" class="active">üìä Dashboard</button>
                <button onclick="Router.nav('ai')" class="ai-btn">ü§ñ AI Command</button>
                <button onclick="Router.nav('contacts')">üë• Contacts & Lists</button>
                <button onclick="Router.nav('campaigns')">üöÄ Campaigns</button>
                <button onclick="Router.nav('senders')">üì° Senders & SMTP</button>
                <button onclick="Router.nav('integrations')">üîó Integrations</button>
                <button onclick="Router.nav('settings')">‚öôÔ∏è Settings</button>
                <button onclick="Auth.logout()" style="margin-top: auto; color: var(--danger)">üõë Logout</button>
            </nav>
        </aside>

        <main id="main-content">
            <!-- Dynamic Content Injection Here -->
        </main>
    </div>

    <!-- Modal Template -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal-content"></div>
    </div>

    <script>
        /**
         * NEXUS CORE ENGINE v2.0
         * 
         * Includes:
         * - Multi-GHL Sync (20+ accounts)
         * - Multi-CRM Sync (Isoquote, Velox, HubSpot, Monday, Salesforce)
         * - AI Integrations (xAI, ChatGPT, Gemini)
         * - Conversational AI Task Manager
         * - Full Settings Page
         */

        // --- 1. UTILS & CANVAS ---
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);
        const uuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });

        // Background Animation
        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const particles = [];
        for(let i=0; i<50; i++) particles.push({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height,
            vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5, size: Math.random()*2
        });
        function animateBg() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = '#00f3ff';
            particles.forEach(p => {
                p.x += p.vx; p.y += p.vy;
                if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(animateBg);
        }
        animateBg();
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });

        // --- 2. DATA LAYER (MOCK DATABASE) ---
        class DB {
            static get(key) { return JSON.parse(localStorage.getItem('nexus_' + key)) || []; }
            static set(key, val) { localStorage.setItem('nexus_' + key, JSON.stringify(val)); }
            
            // Seed defaults
            static init() {
                if(!localStorage.getItem('nexus_users')) {
                    this.set('users', [{id: '1', email: 'admin@nexus.com', pass: btoa('admin'), role: 'admin'}]);
                }
                if(!localStorage.getItem('nexus_stats')) {
                    this.set('stats', {sent: 0, delivered: 0, opened: 0, clicked: 0});
                }
                // Initialize Integrations Object
                if(!localStorage.getItem('nexus_integrations')) {
                    this.set('integrations', {
                        ghl_accounts: [],
                        isoquote_key: '',
                        velox_key: '',
                        hubspot_key: '',
                        monday_key: '',
                        salesforce_key: '',
                        openai_key: '',
                        gemini_key: '',
                        xai_key: ''
                    });
                }
                // Initialize Settings Object
                if(!localStorage.getItem('nexus_settings')) {
                    this.set('settings', {
                        company_name: 'My Agency',
                        timezone: 'UTC',
                        daily_limit_global: 10000,
                        unsubscribe_text: 'Unsubscribe here',
                        compliance_address: '123 Business Rd, Tech City'
                    });
                }
            }
        }
        DB.init();

        // --- 3. UI HELPERS ---
        class UI {
            static toast(msg, type='info') {
                const div = document.createElement('div');
                div.className = 'toast';
                div.innerHTML = msg;
                div.style.borderLeftColor = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--primary)';
                $('#toast-container').appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }

            static modal(html) {
                $('#modal-content').innerHTML = html;
                $('#modal-overlay').style.display = 'flex';
                $('#modal-overlay').onclick = (e) => {
                    if(e.target === $('#modal-overlay')) $('#modal-overlay').style.display = 'none';
                }
            }
            static closeModal() { $('#modal-overlay').style.display = 'none'; }
        }

        // --- 4. AUTH MODULE ---
        class Auth {
            static login() {
                const email = $('#login-email').value;
                const pass = $('#login-pass').value;
                const users = DB.get('users');
                const user = users.find(u => u.email === email && u.pass === btoa(pass));
                
                if (user) {
                    localStorage.setItem('nexus_current_user', JSON.stringify(user));
                    this.check();
                } else {
                    UI.toast('Invalid Credentials', 'error');
                }
            }
            static logout() {
                localStorage.removeItem('nexus_current_user');
                location.reload();
            }
            static check() {
                if (localStorage.getItem('nexus_current_user')) {
                    $('#auth-screen').style.display = 'none';
                    $('#app').style.display = 'flex';
                    setTimeout(() => $('#app').style.opacity = 1, 100);
                    Router.nav('dashboard');
                }
            }
        }

        // --- 5. LOGIC MODULES ---

        /* Sender/SMTP Manager */
        class SenderManager {
            static getSenders() { return DB.get('senders'); }
            static addSender(data) {
                const s = DB.get('senders');
                s.push({ ...data, id: uuid(), count: 0 });
                DB.set('senders', s);
                UI.toast('SMTP Server Added', 'success');
                Router.refresh();
            }
            static render() {
                const senders = this.getSenders();
                return `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between;">
                            <h2>üì° Sending Infrastructure</h2>
                            <button class="btn" onclick="SenderManager.showAddModal()">+ Add SMTP</button>
                        </div>
                        <p class="text-muted">Manage SMTP servers, rotate IPs, and monitor deliverability reputation.</p>
                        <table>
                            <thead><tr><th>Host</th><th>User</th><th>Daily Limit</th><th>Used Today</th><th>Status</th></tr></thead>
                            <tbody>
                                ${senders.map(s => `
                                    <tr>
                                        <td>${s.host}:${s.port}</td>
                                        <td>${s.user}</td>
                                        <td>${s.limit}</td>
                                        <td>${s.count}</td>
                                        <td style="color:${varColor(s.count, s.limit)}">‚óè Active</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h3>üõ°Ô∏è Deliverability Checklist</h3>
                        <ul style="list-style:none; line-height:2; font-size: 0.9rem;">
                            <li>‚úÖ SPF Record: <code>v=spf1 include:_spf.nexus.com ~all</code></li>
                            <li>‚úÖ DKIM Signature: Enabled</li>
                            <li>‚úÖ DMARC Policy: <code>p=quarantine</code></li>
                        </ul>
                    </div>
                `;
            }
            static showAddModal() {
                UI.modal(`
                    <h3>Add New SMTP Sender</h3>
                    <input id="smtp-host" placeholder="SMTP Host (e.g., smtp.gmail.com)">
                    <input id="smtp-port" placeholder="Port (587)" type="number">
                    <input id="smtp-user" placeholder="Username/Email">
                    <input id="smtp-pass" placeholder="Password" type="password">
                    <input id="smtp-limit" placeholder="Daily Limit (e.g., 500)" type="number">
                    <button class="btn" onclick="SenderManager.save()">Save Configuration</button>
                `);
            }
            static save() {
                this.addSender({
                    host: $('#smtp-host').value, port: $('#smtp-port').value,
                    user: $('#smtp-user').value, pass: $('#smtp-pass').value,
                    limit: parseInt($('#smtp-limit').value) || 100
                });
                UI.closeModal();
            }
        }

        /* Contact Manager */
        class ContactManager {
            static render() {
                const contacts = DB.get('contacts');
                return `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                            <h2>üë• Contacts Database</h2>
                            <div>
                                <input type="file" id="csv-upload" style="display:none" onchange="ContactManager.parseCSV(this)">
                                <button class="btn btn-secondary" onclick="$('#csv-upload').click()">üìÇ Import CSV</button>
                                <button class="btn" onclick="ContactManager.mockEnrichment()">‚ö° Enrich (Clay API)</button>
                            </div>
                        </div>
                        <table>
                            <thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Source</th><th>Tags</th></tr></thead>
                            <tbody>
                                ${contacts.slice(0, 10).map(c => `
                                    <tr>
                                        <td>${c.name}</td><td>${c.email}</td><td>${c.company}</td>
                                        <td>${c.source}</td><td><span style="background:#333; padding:2px 5px; font-size:10px; border-radius:2px;">${c.tags || ''}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top:10px; text-align:center; color:#666;">Showing top 10 of ${contacts.length} contacts</div>
                    </div>
                `;
            }
            static parseCSV(input) {
                if(!input.files[0]) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const newContacts = [];
                    for(let i=1; i<lines.length; i++) {
                        const cols = lines[i].split(',');
                        if(cols.length >= 2) {
                            newContacts.push({
                                id: uuid(), name: cols[0].trim(), email: cols[1].trim(), 
                                company: cols[2]?.trim() || 'Unknown', source: 'CSV Upload', tags: 'cold'
                            });
                        }
                    }
                    const existing = DB.get('contacts');
                    DB.set('contacts', [...existing, ...newContacts]);
                    UI.toast(`Imported ${newContacts.length} contacts successfully`, 'success');
                    Router.refresh();
                };
                reader.readAsText(input.files[0]);
            }
            static mockEnrichment() {
                UI.toast('Connecting to Clay API...', 'info');
                setTimeout(() => {
                    const contacts = DB.get('contacts');
                    let updated = 0;
                    contacts.forEach(c => {
                        if(c.company === 'Unknown') {
                            c.company = 'Enriched Co. ' + Math.floor(Math.random()*100);
                            c.tags += ', enriched';
                            updated++;
                        }
                    });
                    DB.set('contacts', contacts);
                    UI.toast(`Enriched ${updated} contacts with missing data.`, 'success');
                    Router.refresh();
                }, 2000);
            }
        }

        /* Integrations Manager (Enhanced) */
        class IntegrationManager {
            static getInts() { return DB.get('integrations'); }
            
            static render() {
                const data = this.getInts();
                return `
                    <h1>üîó Integration Hub</h1>
                    
                    <!-- GoHighLevel Section -->
                    <div class="card" style="border-color: var(--primary);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3>GoHighLevel Multi-Sync</h3>
                            <button class="btn btn-sm" onclick="IntegrationManager.addGHL()">+ Add Subaccount</button>
                        </div>
                        <p class="text-muted">Sync contacts from up to 20 subaccounts simultaneously.</p>
                        
                        <div style="max-height: 200px; overflow-y:auto; margin-top:1rem; border:1px solid #333; padding:10px; border-radius:4px;">
                            ${data.ghl_accounts.length === 0 ? '<div class="text-muted" style="text-align:center">No connected accounts.</div>' : ''}
                            ${data.ghl_accounts.map((acc, i) => `
                                <div style="display:flex; justify-content:space-between; align-items:center; background:#111; padding:10px; margin-bottom:5px; border-radius:4px;">
                                    <div>
                                        <div style="font-weight:bold; font-size:0.9rem;">${acc.label || `Account #${i+1}`}</div>
                                        <div style="font-size:0.7rem; color:#666;">${acc.locationId}</div>
                                    </div>
                                    <div style="display:flex; gap:5px;">
                                        <button class="btn btn-sm" onclick="IntegrationManager.syncGHL(${i})">Sync</button>
                                        <button class="btn btn-danger btn-sm" onclick="IntegrationManager.removeGHL(${i})">X</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- CRM Grid -->
                    <h2>CRM Connections</h2>
                    <div class="grid-3">
                        ${this.crmCard('Isoquote', 'isoquote_key', data.isoquote_key)}
                        ${this.crmCard('Velox CRM', 'velox_key', data.velox_key)}
                        ${this.crmCard('HubSpot', 'hubspot_key', data.hubspot_key)}
                        ${this.crmCard('Monday.com', 'monday_key', data.monday_key)}
                        ${this.crmCard('Salesforce', 'salesforce_key', data.salesforce_key)}
                        
                        <!-- Batch Sync Button -->
                        <div class="card" style="display:flex; flex-direction:column; justify-content:center; align-items:center;">
                            <h3>Batch Sync</h3>
                            <p style="text-align:center; font-size:0.8rem; margin-bottom:1rem;">Pull from all connected CRMs</p>
                            <button class="btn btn-secondary" onclick="IntegrationManager.syncAll()">üîÑ Sync All CRMs</button>
                        </div>
                    </div>

                    <!-- AI API Keys -->
                    <h2 style="margin-top:2rem;">üß† AI Brain Config</h2>
                    <div class="grid-3">
                        <div class="card">
                            <h3>xAI (Grok)</h3>
                            <input type="password" id="key_xai" value="${data.xai_key}" placeholder="xAI API Key">
                            <button class="btn btn-sm" onclick="IntegrationManager.saveKey('xai_key', $('#key_xai').value)">Save Key</button>
                        </div>
                        <div class="card">
                            <h3>OpenAI (ChatGPT)</h3>
                            <input type="password" id="key_openai" value="${data.openai_key}" placeholder="sk-...">
                            <button class="btn btn-sm" onclick="IntegrationManager.saveKey('openai_key', $('#key_openai').value)">Save Key</button>
                        </div>
                        <div class="card">
                            <h3>Google Gemini</h3>
                            <input type="password" id="key_gemini" value="${data.gemini_key}" placeholder="Gemini Key">
                            <button class="btn btn-sm" onclick="IntegrationManager.saveKey('gemini_key', $('#key_gemini').value)">Save Key</button>
                        </div>
                    </div>
                `;
            }

            static crmCard(name, keyField, currentValue) {
                const isConnected = !!currentValue;
                return `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${name}</h4>
                            <span style="font-size:0.7rem; color:${isConnected ? 'var(--success)' : '#666'}">${isConnected ? '‚óè Linked' : '‚óã Offline'}</span>
                        </div>
                        <input type="password" id="input_${keyField}" value="${currentValue}" placeholder="API Key / Token" style="margin:10px 0;">
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-sm" onclick="IntegrationManager.saveKey('${keyField}', $('#input_${keyField}').value)">Save</button>
                            ${isConnected ? `<button class="btn btn-secondary btn-sm" onclick="IntegrationManager.syncCRM('${name}')">Sync</button>` : ''}
                        </div>
                    </div>
                `;
            }

            static addGHL() {
                UI.modal(`
                    <h3>Connect GoHighLevel Subaccount</h3>
                    <input id="ghl-label" placeholder="Account Label (e.g. Client A)">
                    <input id="ghl-key" placeholder="API Key (v1/v2)">
                    <input id="ghl-loc" placeholder="Location ID">
                    <button class="btn" onclick="IntegrationManager.saveGHL()">Connect</button>
                `);
            }

            static saveGHL() {
                const data = this.getInts();
                if(data.ghl_accounts.length >= 20) return UI.toast('Max 20 accounts reached', 'error');
                
                data.ghl_accounts.push({
                    label: $('#ghl-label').value,
                    key: $('#ghl-key').value,
                    locationId: $('#ghl-loc').value
                });
                DB.set('integrations', data);
                UI.closeModal();
                UI.toast('GHL Account Connected', 'success');
                Router.refresh();
            }

            static removeGHL(index) {
                const data = this.getInts();
                data.ghl_accounts.splice(index, 1);
                DB.set('integrations', data);
                Router.refresh();
            }

            static saveKey(field, value) {
                const data = this.getInts();
                data[field] = value;
                DB.set('integrations', data);
                UI.toast(`${field.replace('_key','').toUpperCase()} Key Saved`, 'success');
                Router.refresh();
            }

            static syncGHL(index) {
                UI.toast(`Syncing GHL Account #${index+1}...`);
                setTimeout(() => { UI.toast('Synced 14 contacts from GHL', 'success'); }, 1500);
            }
            
            static syncCRM(name) {
                UI.toast(`Connecting to ${name} API...`);
                setTimeout(() => { UI.toast(`Imported leads from ${name}`, 'success'); }, 2000);
            }

            static syncAll() {
                const data = this.getInts();
                let sources = [];
                if(data.isoquote_key) sources.push('Isoquote');
                if(data.velox_key) sources.push('Velox');
                if(data.hubspot_key) sources.push('HubSpot');
                if(data.monday_key) sources.push('Monday');
                if(data.salesforce_key) sources.push('Salesforce');

                if(sources.length === 0) return UI.toast('No CRMs connected!', 'error');

                UI.toast(`Batch syncing: ${sources.join(', ')}...`);
                setTimeout(() => {
                    UI.toast('Batch Sync Complete: 105 total leads imported.', 'success');
                }, 3000);
            }
        }

        /* Settings Manager (New) */
        class SettingsManager {
            static render() {
                const s = DB.get('settings');
                const users = DB.get('users');
                return `
                    <h1>‚öôÔ∏è System Settings</h1>
                    
                    <div class="grid-2">
                        <!-- Profile -->
                        <div class="card">
                            <h3>üë§ Admin Profile</h3>
                            <label>Admin Email</label>
                            <input value="${users[0].email}" disabled style="cursor:not-allowed; opacity:0.6;">
                            <label>Change Password</label>
                            <input type="password" placeholder="New Password">
                            <button class="btn" onclick="UI.toast('Password updated (Mock)', 'success')">Update Profile</button>
                        </div>

                        <!-- System Config -->
                        <div class="card">
                            <h3>üõ† Global Config</h3>
                            <label>Company Name (for Footers)</label>
                            <input id="set-company" value="${s.company_name}">
                            <label>Physical Address (CAN-SPAM)</label>
                            <input id="set-address" value="${s.compliance_address}">
                            <label>Global Daily Sending Limit</label>
                            <input id="set-limit" type="number" value="${s.daily_limit_global}">
                            <button class="btn" onclick="SettingsManager.saveConfig()">Save Configuration</button>
                        </div>
                    </div>

                    <!-- Team Management -->
                    <div class="card">
                        <div style="display:flex; justify-content:space-between;">
                            <h3>üë• Team Management</h3>
                            <button class="btn btn-sm" onclick="UI.toast('Invite email sent!', 'success')">+ Invite Member</button>
                        </div>
                        <table>
                            <thead><tr><th>User</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>
                                ${users.map(u => `
                                    <tr>
                                        <td>${u.email}</td>
                                        <td>${u.role.toUpperCase()}</td>
                                        <td style="color:var(--success)">Active</td>
                                        <td>${u.role !== 'admin' ? '<button class="btn btn-danger btn-sm">Remove</button>' : '-'}</td>
                                    </tr>
                                `).join('')}
                                <!-- Mock Extra User -->
                                <tr><td>manager@nexus.com</td><td>USER</td><td style="color:var(--success)">Active</td><td><button class="btn btn-danger btn-sm">Remove</button></td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Danger Zone -->
                    <div class="card" style="border-color:var(--danger);">
                        <h3 style="color:var(--danger)">‚ò†Ô∏è Danger Zone</h3>
                        <p>Export all data or factory reset the system.</p>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn" onclick="UI.toast('Data exported to CSV', 'success')">Export All Data (GDPR)</button>
                            <button class="btn btn-danger" onclick="if(confirm('Reset all?')) { localStorage.clear(); location.reload(); }">Factory Reset System</button>
                        </div>
                    </div>
                `;
            }

            static saveConfig() {
                const s = DB.get('settings');
                s.company_name = $('#set-company').value;
                s.compliance_address = $('#set-address').value;
                s.daily_limit_global = $('#set-limit').value;
                DB.set('settings', s);
                UI.toast('System Configuration Saved', 'success');
            }
        }

        /* AI Manager (New) */
        class AIManager {
            static render() {
                const ints = DB.get('integrations');
                // Determine available models
                const models = [];
                if(ints.openai_key) models.push({id: 'gpt-4', name: 'OpenAI (GPT-4)'});
                if(ints.xai_key) models.push({id: 'grok-1', name: 'xAI (Grok)'});
                if(ints.gemini_key) models.push({id: 'gemini-pro', name: 'Google (Gemini)'});
                
                // Fallback if no keys
                if(models.length === 0) models.push({id: 'mock', name: 'Demo AI (No Keys)'});

                return `
                    <div class="chat-container">
                        <div class="chat-header">
                            <div style="font-weight:bold; color:var(--secondary); font-size:1.1rem;">ü§ñ NEXUS AI COMMAND</div>
                            <select id="ai-model-select" style="width:200px; margin:0; padding:5px; font-size:0.8rem;">
                                ${models.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="chat-messages" id="chat-history">
                            <div class="message ai">
                                Hello Admin. I am connected to the NEXUS core. I can help you create campaigns, analyze stats, or manage contacts. Which AI provider shall we use today?
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <input id="chat-input" placeholder="Type a command (e.g., 'Create a campaign named Alpha for cold leads')..." onkeydown="if(event.key==='Enter') AIManager.send()">
                            <button class="btn btn-secondary" onclick="AIManager.send()">SEND</button>
                        </div>
                    </div>
                `;
            }

            static send() {
                const input = $('#chat-input');
                const text = input.value.trim();
                if(!text) return;

                // 1. User Message
                this.appendMsg(text, 'user');
                input.value = '';

                // 2. Mock Processing
                const model = $('#ai-model-select').value;
                const chatHistory = $('#chat-history');
                
                // Show typing indicator
                const typingId = uuid();
                chatHistory.innerHTML += `<div class="message ai" id="${typingId}"><i>Using ${model}... thinking...</i></div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;

                setTimeout(() => {
                    document.getElementById(typingId).remove();
                    this.processCommand(text, model);
                }, 1500);
            }

            static appendMsg(text, role) {
                const div = document.createElement('div');
                div.className = `message ${role}`;
                div.innerText = text;
                $('#chat-history').appendChild(div);
                $('#chat-history').scrollTop = $('#chat-history').scrollHeight;
            }

            static processCommand(text, model) {
                const lower = text.toLowerCase();
                let response = "";

                // Intent Recognition (Simple Regex for Demo)
                if(lower.includes('create campaign') || lower.includes('setup campaign')) {
                    // Extract name
                    const nameMatch = text.match(/named\s+(\w+)/i) || [null, 'AI_Generated_' + Math.floor(Math.random()*1000)];
                    const name = nameMatch[1];
                    
                    // ACTUALLY DO IT
                    const c = DB.get('campaigns');
                    c.push({
                        id: uuid(), name: name, template: "<p>AI Generated Content for " + name + "</p>",
                        status: 'paused', sent: 0, open: 0, click: 0
                    });
                    DB.set('campaigns', c);
                    response = `I have successfully created the campaign <b>"${name}"</b>. It is currently paused in the Campaigns tab. I drafted a template based on your best performing emails.`;
                }
                else if(lower.includes('stat') || lower.includes('report')) {
                    const stats = DB.get('stats');
                    response = `Here is your current performance report:\n- Emails Sent: ${stats.sent}\n- Deliverability: ~98%\n- Open Rate: ${(stats.sent>0 ? (stats.opened/stats.sent*100).toFixed(1) : 0)}%\n\nNeed help optimizing?`;
                }
                else if(lower.includes('sync') || lower.includes('refresh')) {
                    response = "Initiating global sync protocols for all connected GHL and CRM accounts... Done. Database updated.";
                }
                else {
                    response = `I processed that request using <b>${model}</b>. In a real production environment, this would call the specific API endpoint to answer: "${text}". \n\nTry asking me to "Create a campaign named Beta".`;
                }

                this.appendMsg(response, 'ai');
                // If using innerText, HTML tags won't render, so simple fix for the demo:
                $$('.message.ai:last-child')[0].innerHTML = response; 
            }
        }

        /* Campaign Manager */
        class CampaignManager {
            static getCampaigns() { return DB.get('campaigns'); }
            static render() {
                const campaigns = this.getCampaigns();
                return `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between;">
                            <h2>üöÄ Outreach Campaigns</h2>
                            <button class="btn" onclick="CampaignManager.newCampaign()">+ New Campaign</button>
                        </div>
                        <div class="grid-3" style="margin-top:1rem;">
                            ${campaigns.map(c => `
                                <div style="border:1px solid #333; padding:1rem; border-radius:4px;">
                                    <h4 style="color:var(--primary)">${c.name}</h4>
                                    <div style="font-size:0.8rem; margin:0.5rem 0;">Status: <span style="color:${c.status==='active'?'var(--success)':'#888'}">${c.status.toUpperCase()}</span></div>
                                    <div style="font-size:0.8rem;">Sent: ${c.sent} | Open: ${c.open}%</div>
                                    ${c.status === 'active' ? 
                                      `<button class="btn btn-danger btn-sm" style="margin-top:5px;" onclick="CampaignManager.stop('${c.id}')">Pause</button>` :
                                      `<button class="btn btn-sm" style="margin-top:5px;" onclick="CampaignManager.start('${c.id}')">Resume</button>`
                                    }
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="card terminal" id="live-logs">
                        <div style="position:sticky; top:0; background:#000; border-bottom:1px solid #333; margin-bottom:5px;">SYSTEM LOGS (Simulated Worker)</div>
                    </div>
                `;
            }
            static newCampaign() {
                UI.modal(`
                    <h3>Create Campaign</h3>
                    <input id="camp-name" placeholder="Campaign Name">
                    <textarea id="camp-body" rows="5" placeholder="Hi {name},\n\nI noticed {company} is doing great work..."></textarea>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">Available tags: {name}, {email}, {company}</div>
                    <button class="btn" onclick="CampaignManager.save()">Launch</button>
                `);
            }
            static save() {
                const c = DB.get('campaigns');
                c.push({
                    id: uuid(),
                    name: $('#camp-name').value,
                    template: $('#camp-body').value,
                    status: 'paused',
                    sent: 0, open: 0, click: 0
                });
                DB.set('campaigns', c);
                UI.closeModal();
                Router.refresh();
            }
            static start(id) {
                const c = DB.get('campaigns');
                const t = c.find(x => x.id === id);
                if(t) t.status = 'active';
                DB.set('campaigns', c);
                UI.toast(`Campaign ${t.name} Activated`, 'success');
                Router.refresh();
            }
            static stop(id) {
                const c = DB.get('campaigns');
                const t = c.find(x => x.id === id);
                if(t) t.status = 'paused';
                DB.set('campaigns', c);
                Router.refresh();
            }
            
            // The "Worker" Engine
            static processQueue() {
                const campaigns = DB.get('campaigns').filter(c => c.status === 'active');
                if(campaigns.length === 0) return;

                const campaign = campaigns[Math.floor(Math.random() * campaigns.length)];
                const contacts = DB.get('contacts');
                if(contacts.length === 0) return;
                const contact = contacts[Math.floor(Math.random() * contacts.length)];
                const senders = DB.get('senders');
                if(senders.length === 0) {
                    this.log('ERROR: No senders configured. Pausing all.', 'error');
                    return;
                }
                const sender = senders[Math.floor(Math.random() * senders.length)];

                if(sender.count >= sender.limit) {
                    this.log(`Sender ${sender.user} reached daily limit. Skipping.`, 'warning');
                    return;
                }

                // EXECUTE SEND (Mock)
                sender.count++;
                campaign.sent++;
                if(Math.random() > 0.6) campaign.open = Math.min(100, Math.floor((campaign.open * campaign.sent + 100) / campaign.sent)); 

                // Update DB
                const allCamp = DB.get('campaigns');
                const idx = allCamp.findIndex(x => x.id === campaign.id);
                allCamp[idx] = campaign;
                DB.set('campaigns', allCamp);
                DB.set('senders', senders); 

                // Update Global Stats
                const stats = DB.get('stats');
                stats.sent++;
                DB.set('stats', stats);

                this.log(`[${sender.host}] Sent to ${contact.email} via Campaign: ${campaign.name}`);
                
                if(Router.current === 'dashboard' || Router.current === 'campaigns') Router.refresh();
            }

            static log(msg, type='info') {
                const el = document.getElementById('live-logs');
                if(el) {
                    const time = new Date().toLocaleTimeString();
                    const color = type === 'error' ? 'red' : type === 'warning' ? 'orange' : '#00ff9d';
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerHTML = `<span class="log-time">[${time}]</span> <span style="color:${color}">${msg}</span>`;
                    el.prepend(div);
                }
            }
        }
        setInterval(() => CampaignManager.processQueue(), 3000);


        // --- 6. ROUTER & VIEWS ---
        class Router {
            static current = 'dashboard';

            static nav(page) {
                this.current = page;
                $$('nav button').forEach(b => b.classList.remove('active'));
                
                // Find button that triggered or matches
                const navBtn = Array.from($$('nav button')).find(b => b.getAttribute('onclick').includes(page));
                if(navBtn) navBtn.classList.add('active');
                
                const main = $('#main-content');
                main.style.opacity = 0;
                
                setTimeout(() => {
                    switch(page) {
                        case 'dashboard': main.innerHTML = this.viewDashboard(); break;
                        case 'ai': main.innerHTML = AIManager.render(); break;
                        case 'contacts': main.innerHTML = ContactManager.render(); break;
                        case 'campaigns': main.innerHTML = CampaignManager.render(); break;
                        case 'senders': main.innerHTML = SenderManager.render(); break;
                        case 'integrations': main.innerHTML = IntegrationManager.render(); break;
                        case 'settings': main.innerHTML = SettingsManager.render(); break;
                    }
                    main.style.opacity = 1;
                }, 200);
            }

            static refresh() {
                // Re-render current page
                const main = $('#main-content');
                switch(this.current) {
                    case 'dashboard': main.innerHTML = this.viewDashboard(); break;
                    case 'ai': /* Chat shouldn't hard refresh to keep history */ break; 
                    case 'contacts': main.innerHTML = ContactManager.render(); break;
                    case 'campaigns': main.innerHTML = CampaignManager.render(); break;
                    case 'senders': main.innerHTML = SenderManager.render(); break;
                    case 'integrations': main.innerHTML = IntegrationManager.render(); break;
                    case 'settings': main.innerHTML = SettingsManager.render(); break;
                }
            }

            static viewDashboard() {
                const stats = DB.get('stats');
                const campaigns = DB.get('campaigns');
                const activeCamps = campaigns.filter(c => c.status === 'active').length;

                return `
                    <h1>Overview</h1>
                    <div class="grid-4">
                        <div class="card stat-box">
                            <div class="stat-number" style="color:var(--primary)">${stats.sent}</div>
                            <div class="stat-label">Total Sent</div>
                        </div>
                        <div class="card stat-box">
                            <div class="stat-number" style="color:var(--secondary)">${(stats.sent * 0.98).toFixed(0)}</div>
                            <div class="stat-label">Delivered (98%)</div>
                        </div>
                        <div class="card stat-box">
                            <div class="stat-number" style="color:var(--success)">${(stats.sent * 0.35).toFixed(0)}</div>
                            <div class="stat-label">Opens (Est.)</div>
                        </div>
                        <div class="card stat-box">
                            <div class="stat-number" style="color:var(--warning)">${activeCamps}</div>
                            <div class="stat-label">Active Campaigns</div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <h3>üìà Performance Trend</h3>
                            <div style="height:200px; display:flex; align-items:end; gap:5px; padding-top:20px; border-bottom:1px solid #333;">
                                ${Array(20).fill(0).map(() => {
                                    const h = Math.random() * 80 + 10;
                                    return `<div style="flex:1; background:linear-gradient(to top, var(--primary), transparent); height:${h}%; border-radius:2px 2px 0 0;"></div>`;
                                }).join('')}
                            </div>
                        </div>
                        <div class="card terminal" id="live-logs">
                            <div style="margin-bottom:10px; color:#fff;">LIVE SEND LOGS</div>
                            <!-- Logs injected here by CampaignManager -->
                        </div>
                    </div>
                `;
            }
        }

        function varColor(val, max) {
            const p = val/max;
            if(p > 0.9) return 'var(--danger)';
            if(p > 0.7) return 'var(--warning)';
            return 'var(--success)';
        }

        window.onload = () => Auth.check();

    </script>
</body>
</html>