# Nexus Email Sender - Cloudflare Configuration
name = "nexus-email-sender"
compatibility_date = "2024-12-01"
pages_build_output_dir = "."

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "nexus-db"
database_id = "placeholder" # Replace with actual database ID after creation

# KV Namespace bindings
[[kv_namespaces]]
binding = "KV_CACHE"
id = "placeholder" # For rate limits, idempotency keys, short locks

# R2 Bucket binding
[[r2_buckets]]
binding = "R2_STORAGE"
bucket_name = "nexus-uploads"

# Queue binding (for send jobs)
[[queues.producers]]
binding = "SEND_QUEUE"
queue = "nexus-send-jobs"

[[queues.consumers]]
queue = "nexus-send-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "nexus-send-dlq"

# Durable Objects
[[durable_objects.bindings]]
name = "SEND_COORDINATOR"
class_name = "SendCoordinator"
script_name = "nexus-email-sender"

[[migrations]]
tag = "v1"
new_classes = ["SendCoordinator"]

# Environment variables (set these in Cloudflare dashboard or via secrets)
[vars]
APP_ORIGIN = "https://nexus.example.com" # Replace with your domain
GOOGLE_CLIENT_ID = "your-google-client-id"
GOOGLE_CLIENT_SECRET = "" # Use wrangler secret put
MICROSOFT_CLIENT_ID = "your-microsoft-client-id"
MICROSOFT_CLIENT_SECRET = "" # Use wrangler secret put
TURNSTILE_SITE_KEY = "your-turnstile-site-key"
TURNSTILE_SECRET_KEY = "" # Use wrangler secret put

# Secrets (set via: wrangler secret put SECRET_NAME)
# - ENCRYPTION_KEY_B64: Base64-encoded 256-bit key for OAuth token encryption
# - IP_HASH_SALT: Random string for IP hashing
# - SESSION_SECRET: Random string for session token signing
# - GOOGLE_CLIENT_SECRET
# - MICROSOFT_CLIENT_SECRET
# - TURNSTILE_SECRET_KEY

[build]
command = "echo 'No build step required for static files'"

# Local development
[env.dev]
name = "nexus-email-sender-dev"

[env.dev.vars]
APP_ORIGIN = "http://localhost:8788"
